# This workflow builds and releases the MusicPlayer application for Windows
name: Build and Release MusicPlayer

on:
  push:
    branches: [ "master", "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "master", "main" ]

env:
  BUILD_TYPE: Release
  QT_VERSION: "6.8.1"

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup vcpkg
      shell: powershell
      run: |
        # Clone vcpkg repository
        git clone https://github.com/microsoft/vcpkg.git $env:GITHUB_WORKSPACE\vcpkg
        
        # Install vcpkg
        cd $env:GITHUB_WORKSPACE\vcpkg
        .\bootstrap-vcpkg.bat -disableMetrics
        
        # Install TagLib
        .\vcpkg install taglib:x64-windows

    - name: Setup Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ env.QT_VERSION }}
        host: windows
        target: desktop
        arch: win64_msvc2022_64
        modules: 'qtmultimedia'
        tools: tools_cmake
        cache: true

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
      
    - name: Configure CMake
      shell: powershell
      run: |
        $vcpkgToolchain = "$env:GITHUB_WORKSPACE\vcpkg\scripts\buildsystems\vcpkg.cmake"
        echo "Using vcpkg toolchain file: $vcpkgToolchain"
        echo "Qt6 directory: $env:Qt6_DIR"
        
        cmake -B ${{github.workspace}}/build `
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DCMAKE_TOOLCHAIN_FILE="$vcpkgToolchain" `
          -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" `
          -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

    - name: Deploy Qt Libraries
      shell: powershell
      run: |
        # Add Qt bin directory to PATH
        $env:PATH += ";$env:Qt6_DIR/bin"
        
        # Create release package directory
        New-Item -Path release-package -ItemType Directory -Force
        
        # Find executable
        $exePath = "$env:GITHUB_WORKSPACE\build\Release\MusicPlayer.exe"
        
        if (Test-Path $exePath) {
          Write-Host "Found executable at expected location: $exePath"
          Copy-Item $exePath -Destination release-package\
        } else {
          Write-Host "Searching for executable in build directory..."
          $foundExe = Get-ChildItem -Path "$env:GITHUB_WORKSPACE\build" -Recurse -Include "MusicPlayer.exe" | Select-Object -First 1
          
          if ($foundExe) {
            Write-Host "Found executable at: $($foundExe.FullName)"
            Copy-Item $foundExe.FullName -Destination release-package\
          } else {
            Write-Host "Executable locations in build directory:"
            Get-ChildItem -Path "$env:GITHUB_WORKSPACE\build" -Recurse -Include "*.exe" | ForEach-Object { Write-Host $_.FullName }
            throw "MusicPlayer.exe not found"
          }
        }
        
        # Run windeployqt
        Write-Host "Running windeployqt..."
        windeployqt --release --no-translations --no-system-d3d-compiler --no-opengl-sw release-package\MusicPlayer.exe
        
        # Copy TagLib DLLs
        $tagLibPath = "$env:GITHUB_WORKSPACE\vcpkg\installed\x64-windows\bin"
        Write-Host "Copying TagLib DLLs from $tagLibPath"
        
        if (Test-Path "$tagLibPath\tag.dll") {
          Copy-Item "$tagLibPath\tag.dll" -Destination release-package\
        } else {
          Write-Host "Warning: tag.dll not found"
        }
        
        if (Test-Path "$tagLibPath\tag_c.dll") {
          Copy-Item "$tagLibPath\tag_c.dll" -Destination release-package\
        } else {
          Write-Host "Warning: tag_c.dll not found"
        }
        
        # List files in release package for verification
        Write-Host "Files in release package:"
        Get-ChildItem -Path release-package -Recurse | ForEach-Object { Write-Host $_.FullName }

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MusicPlayer-Windows-${{ github.sha }}
        path: release-package/

  release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: MusicPlayer-Windows-${{ github.sha }}
        path: release-package/

    - name: Create ZIP package
      run: |
        cd release-package
        zip -r ../MusicPlayer-Windows-${{ github.ref_name }}.zip .

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: MusicPlayer-Windows-${{ github.ref_name }}.zip
        name: MusicPlayer ${{ github.ref_name }}
        body: |
          ## ğŸµ MusicPlayer ${{ github.ref_name }}
          
          ### æ–°åŠŸèƒ½
          - ç°ä»£åŒ–çš„ç”¨æˆ·ç•Œé¢è®¾è®¡
          - å“åº”å¼å¸ƒå±€ï¼Œæ”¯æŒçª—å£å¤§å°è°ƒæ•´
          - æ”¯æŒFLACå’ŒMP3æ ¼å¼éŸ³é¢‘æ’­æ”¾
          - éŸ³é‡æ§åˆ¶å’Œæ’­æ”¾è¿›åº¦æ§åˆ¶
          - æ­Œè¯æ˜¾ç¤ºåŠŸèƒ½
          
          ### ä¸‹è½½è¯´æ˜
          1. ä¸‹è½½ `MusicPlayer-Windows-${{ github.ref_name }}.zip`
          2. è§£å‹åˆ°ä»»æ„æ–‡ä»¶å¤¹
          3. åŒå‡»è¿è¡Œ `MusicPlayer.exe`
          
          ### ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64ä½)
          - æ— éœ€é¢å¤–å®‰è£…Qtè¿è¡Œæ—¶ï¼ˆå·²åŒ…å«åœ¨å‘å¸ƒåŒ…ä¸­ï¼‰
          
          ### ä½¿ç”¨æ–¹æ³•
          1. ç‚¹å‡»"æ‰“å¼€æ–‡ä»¶å¤¹"é€‰æ‹©åŒ…å«éŸ³ä¹æ–‡ä»¶çš„æ–‡ä»¶å¤¹
          2. åŒå‡»éŸ³ä¹åˆ—è¡¨ä¸­çš„æ­Œæ›²å¼€å§‹æ’­æ”¾
          3. ä½¿ç”¨æ’­æ”¾æ§åˆ¶æŒ‰é’®æ§åˆ¶æ’­æ”¾
          4. æ‹–æ‹½è¿›åº¦æ¡è°ƒæ•´æ’­æ”¾ä½ç½®
          5. ç‚¹å‡»"Voice"æŒ‰é’®æ˜¾ç¤º/éšè—éŸ³é‡æ§åˆ¶
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
